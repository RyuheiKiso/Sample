# テストルール(Rust)

---

## 目的

品質担保・バグ防止のため、テスト実装に関するルールを定めます。

---

## 基本方針

- すべてのビジネスロジックに対してユニットテストを作成すること
- 新規機能追加時は必ずテストを追加すること
- バグ修正時は再発防止のためのテストを追加すること

---

## テスト記述ルール

- テストは原則として、テスト対象のモジュールと同じファイル内に`#[cfg(test)] mod tests`として記述する
- テスト関数には`#[test]`属性を付与する
- `assert_eq!`, `assert!`などのアサーションマクロを活用する
- テストケースごとに独立した関数とする

### テストファイルの命名規則

- ユニットテストは各モジュールのファイル内に記述
- 統合テストは`/tests`ディレクトリに、機能や目的が分かるファイル名を付ける（例：`user_api.rs`, `product_flow.rs` など）
- テストファイル名は英小文字・スネークケースで統一する

#### 配置例（ディレクトリ構成との整合）

```
backend/
├── src/
│   ├── user/
│   │   ├── handler.rs
│   │   ├── service.rs
│   │   └── repository.rs
│   └── product/
│       ├── handler.rs
│       ├── service.rs
│       └── repository.rs
└── tests/
    ├── user_api.rs
    └── product_flow.rs
```

### テストを分ける場合の注意点と対策

#### デメリット
- private関数や構造体に統合テストから直接アクセスできない

#### 対策
- テスト対象の関数や構造体を`pub(crate)`や`pub`にする
- テスト用のヘルパーモジュールやテスト専用機能を用意する
- 必要に応じてテスト用の公開インターフェースを用意する

```rust
// 例: テスト用にpub(crate)で公開
pub(crate) fn internal_logic() { ... }
```

- ドキュメントやコードコメントで、公開範囲の意図を明示する

---

## 実行・管理

- `cargo test`で全テストがパスすることをコミット前に必ず確認する
- CI/CDで自動テストを実行し、失敗時はマージ不可とする

---

## カバレッジ（テスト網羅率）

- テストカバレッジの確認には`cargo tarpaulin`等のツールを利用する
- 主要ロジックのカバレッジ80%以上を目標とする
- カバレッジが著しく低い場合は、追加テストの実装を検討する

### カバレッジ計測例

```sh
cargo tarpaulin --out Html
```
- `--out Html`オプションでHTMLレポートが生成されます

---

## その他

- モックやスタブが必要な場合は`mockall`等のライブラリ利用を検討する
- テストコードにも可読性・保守性を意識する

---
