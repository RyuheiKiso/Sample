# テストルール(Rust)

---

## 目的

品質担保・バグ防止のため、テスト実装に関するルールを定めます。

---

## 基本方針

- すべてのビジネスロジックに対してユニットテストを作成すること
- 新規機能追加時は必ずテストを追加すること
- バグ修正時は再発防止のためのテストを追加すること

---

## テスト記述ルール

- テストは原則として、テスト対象のモジュールと同じファイル内に`mod tests`として記述する
- 複雑な結合テストや統合テストは`/tests`ディレクトリに配置する
- テスト関数名は`test_`で始め、何を検証するか分かる名前にする
- `assert_eq!`等のアサーションマクロを活用する
- テストケースごとに独立した関数とする

### テストファイルの命名規則

- ユニットテスト用ファイルは、テスト対象ファイルと同じディレクトリに`_test.rs`を付与して配置する（例：`service.rs` → `service_test.rs`）
- 統合テストはプロジェクトルート直下の`/tests`ディレクトリに、機能や目的が分かるファイル名を付ける（例：`user_api.rs`, `product_flow.rs` など）
- テストファイル名は英小文字・スネークケースで統一する

#### 配置例（ディレクトリ構成との整合）

```
backend/
├── src/
│   ├── features/
│   │   ├── user/
│   │   │   ├── handler.rs
│   │   │   ├── handler_test.rs
│   │   │   ├── service.rs
│   │   │   ├── service_test.rs
│   │   │   ├── repository.rs
│   │   │   └── repository_test.rs
│   │   └── product/
│   │       ├── handler.rs
│   │       ├── handler_test.rs
│   │       ├── service.rs
│   │       ├── service_test.rs
│   │       ├── repository.rs
│   │       └── repository_test.rs
└── tests/
    ├── user_api.rs
    └── product_flow.rs
```

### テストファイルを分ける場合の注意点と対策

#### デメリット
- テスト対象のprivate関数や構造体に直接アクセスできない

#### 対策
- テスト対象の関数や構造体に`pub(crate)`や`pub(super)`を付与し、テストモジュールからアクセスできるようにする
- テスト専用のfeature flagやcfg属性（例：`#[cfg(test)] pub`）を活用する
- 必要に応じてテスト用の公開インターフェースを用意する

```rust
// 例: pub(crate)で公開範囲を限定
pub(crate) fn internal_logic() { ... }
```

- ドキュメントやコードコメントで、公開範囲の意図を明示する

---

## 実行・管理

- `cargo test`で全テストがパスすることをコミット前に必ず確認する
- CI/CDで自動テストを実行し、失敗時はマージ不可とする

---

## カバレッジ（テスト網羅率）

- テストカバレッジの確認には[`cargo-llvm-cov`](https://github.com/taiki-e/cargo-llvm-cov)等のツールを利用する
- 主要ロジックのカバレッジ80%以上を目標とする
- カバレッジが著しく低い場合は、追加テストの実装を検討する

### カバレッジ計測例

```sh
cargo install cargo-llvm-cov
cargo llvm-cov --open
```
- `--open`オプションでHTMLレポートが自動で開きます

---

## その他

- モックやスタブが必要な場合は`mockall`等のクレート利用を検討する
- テストコードにも可読性・保守性を意識する

---
