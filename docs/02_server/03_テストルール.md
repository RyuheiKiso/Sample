# テストルール(Go)

---

## 目的

品質担保・バグ防止のため、テスト実装に関するルールを定めます。

---

## 基本方針

- すべてのビジネスロジックに対してユニットテストを作成すること
- 新規機能追加時は必ずテストを追加すること
- バグ修正時は再発防止のためのテストを追加すること

---

## テスト記述ルール

- テストは原則として、テスト対象のパッケージと同じディレクトリに`xxx_test.go`ファイルとして記述する
- テスト関数名は`Test`で始め、何を検証するか分かる名前にする
- `t.Errorf`, `t.Fatal`などのアサーションを活用する
- テストケースごとに独立した関数とする

### テストファイルの命名規則

- ユニットテスト用ファイルは、テスト対象ファイルと同じディレクトリに`_test.go`を付与して配置する（例：`service.go` → `service_test.go`）
- 統合テストは`/test`ディレクトリに、機能や目的が分かるファイル名を付ける（例：`user_api_test.go`, `product_flow_test.go` など）
- テストファイル名は英小文字・スネークケースで統一する

#### 配置例（ディレクトリ構成との整合）

```
backend/
├── internal/
│   ├── user/
│   │   ├── handler.go
│   │   ├── handler_test.go
│   │   ├── service.go
│   │   ├── service_test.go
│   │   ├── repository.go
│   │   └── repository_test.go
│   └── product/
│       ├── handler.go
│       ├── handler_test.go
│       ├── service.go
│       ├── service_test.go
│       ├── repository.go
│       └── repository_test.go
└── test/
    ├── user_api_test.go
    └── product_flow_test.go
```

### テストファイルを分ける場合の注意点と対策

#### デメリット
- テスト対象のunexported関数や構造体に直接アクセスできない

#### 対策
- テスト対象の関数や構造体をexport（大文字始まり）にする
- テスト専用のビルドタグやテスト用ヘルパー関数を用意する
- 必要に応じてテスト用の公開インターフェースを用意する

```go
// 例: テスト用にexportする
func InternalLogic() { ... }
```

- ドキュメントやコードコメントで、公開範囲の意図を明示する

---

## 実行・管理

- `go test ./...`で全テストがパスすることをコミット前に必ず確認する
- CI/CDで自動テストを実行し、失敗時はマージ不可とする

---

## カバレッジ（テスト網羅率）

- テストカバレッジの確認には`go test -cover`や`go tool cover`等のツールを利用する
- 主要ロジックのカバレッジ80%以上を目標とする
- カバレッジが著しく低い場合は、追加テストの実装を検討する

### カバレッジ計測例

```sh
go test -coverprofile=cover.out ./...
go tool cover -html=cover.out
```
- `-html`オプションでHTMLレポートが自動で開きます

---

## その他

- モックやスタブが必要な場合は`github.com/golang/mock/gomock`等のライブラリ利用を検討する
- テストコードにも可読性・保守性を意識する

---
